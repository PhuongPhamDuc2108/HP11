<!doctype html>
{% load static %}
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Trang thương mại điện tử{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">
  </head>
  <body>
    <header class="shadow-sm sticky-top">
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
          <a class="navbar-brand fw-bold text-danger" href="/">Shopee Style</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <form class="d-flex flex-grow-1 mx-lg-3" action="/" method="get">
              <input class="form-control me-2" type="search" placeholder="Tìm kiếm sản phẩm" aria-label="Search" name="q" value="{{ current_query }}">
              <button class="btn btn-outline-danger" type="submit"><i class="bi bi-search"></i></button>
            </form>
            <ul class="navbar-nav mb-2 mb-lg-0">
              <li class="nav-item me-3">
                <a class="nav-link position-relative" href="{% url 'cart_view' %}">
                  <i class="bi bi-cart3 fs-5"></i>
                  {% if cart_count and cart_count > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                      {{ cart_count }}
                      <span class="visually-hidden">sản phẩm trong giỏ</span>
                    </span>
                  {% endif %}
                </a>
              </li>
              {% if user.is_authenticated %}
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    {{ user.username }}
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/admin/" target="_blank">Trang quản trị</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <form action="{% url 'logout' %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item">Đăng xuất</button>
                      </form>
                    </li>
                  </ul>
                </li>
              {% else %}
                <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Đăng nhập</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'register' %}">Đăng ký</a></li>
              {% endif %}
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main class="py-4">
      <div class="container">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
        {% block content %}{% endblock %}
      </div>
    </main>

    <footer class="py-4 bg-light mt-5 border-top">
      <div class="container text-center text-muted small">
        <div>Demo marketplace lấy cảm hứng từ Shopee. Không sao chép giao diện/nhãn hiệu.</div>
      </div>
    </footer>

    <!-- Floating Chatbot Button -->
    <button id="chatbotToggle" type="button" class="btn btn-danger shadow-lg rounded-circle position-fixed" style="right: 20px; bottom: 20px; width: 56px; height: 56px; z-index: 1050;">
      <i class="bi bi-chat-dots"></i>
    </button>

    <!-- Offcanvas Chatbot Panel -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="chatbotCanvas" aria-labelledby="chatbotCanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="chatbotCanvasLabel">Trợ lý mua sắm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body d-flex flex-column" style="height: 100%;">
        <div id="chatMessages" class="flex-grow-1 border rounded p-2 mb-2 overflow-auto bg-light" style="min-height: 280px;">
          <div class="text-muted small">Xin chào! Tôi có thể giúp gì cho bạn? Hãy đặt câu hỏi về sản phẩm, giá, tồn kho, flash sale...</div>
        </div>
        <form id="chatForm" class="d-flex gap-2" autocomplete="off">
          <input id="chatInput" class="form-control" type="text" placeholder="Nhập câu hỏi..." />
          <button id="chatSend" class="btn btn-danger" type="submit">
            <span class="send-text">Gửi</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (function() {
        const toggleBtn = document.getElementById('chatbotToggle');
        const canvasEl = document.getElementById('chatbotCanvas');
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('chatSend');
        const spinner = sendBtn.querySelector('.spinner-border');
        const sendText = sendBtn.querySelector('.send-text');

        let offcanvasInstance = null;
        let history = [];

        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function ensureOffcanvas() {
          if (!offcanvasInstance) {
            offcanvasInstance = new bootstrap.Offcanvas(canvasEl);
          }
          return offcanvasInstance;
        }

        function scrollToBottom() {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendMessage(role, text) {
          const wrap = document.createElement('div');
          wrap.className = role === 'user' ? 'text-end my-2' : 'text-start my-2';
          const bubble = document.createElement('div');
          bubble.className = role === 'user' ? 'd-inline-block bg-danger text-white p-2 rounded-3' : 'd-inline-block bg-white border p-2 rounded-3';
          bubble.style.maxWidth = '80%';
          bubble.innerText = text;
          wrap.appendChild(bubble);
          chatMessages.appendChild(wrap);
          scrollToBottom();
        }

        function setLoading(loading) {
          chatInput.disabled = loading;
          sendBtn.disabled = loading;
          spinner.classList.toggle('d-none', !loading);
          sendText.classList.toggle('d-none', loading);
        }

        toggleBtn.addEventListener('click', function() {
          ensureOffcanvas().toggle();
          setTimeout(() => chatInput.focus(), 300);
        });

        chatForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const msg = chatInput.value.trim();
          if (!msg) return;

          appendMessage('user', msg);
          chatInput.value = '';
          setLoading(true);

          try {
            const res = await fetch('{% url "chat_api" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken || ''
              },
              body: JSON.stringify({ message: msg, history: history })
            });
            let replyText = '';
            if (res.ok) {
              const data = await res.json();
              replyText = data.reply || '';
            } else {
              replyText = 'Xin lỗi, server gặp lỗi khi gọi trợ lý. Hãy thử lại sau.';
            }
            appendMessage('assistant', replyText);
            history.push({ role: 'user', content: msg });
            history.push({ role: 'assistant', content: replyText });
          } catch (err) {
            appendMessage('assistant', 'Không thể kết nối đến máy chủ. Kiểm tra mạng và thử lại.');
          } finally {
            setLoading(false);
          }
        });
      })();
    </script>
    {% block extra_scripts %}{% endblock %}
  </body>
</html>
